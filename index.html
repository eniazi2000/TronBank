<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/Site.css" rel="stylesheet" />
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/qrcode.min.js"></script>
    <link href="css/bootstrap.css" rel="stylesheet" />
    <title>Document</title>
</head>

<body>
    <div class="container body-content">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center">Simple Tron(TRX) bank</h1>
                <hr />
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="col-md-12 jumbotron text-center">
                    <div id="bankQRcode"></div>
                    <h3>Bank balance</h3>
                    <h2 id="bankBalance">0</h2><span> (TRX) </span>
                </div>
            </div>
            <div class="col-md-9">
                <div class="col-md-6">
                    <h2>your wallet:</h2>
                    <h4 id="userWalletAddress"></h4>
                    <h2>your wallet balance:</h2>
                    <h4 id="userWalletBalance">0</h4><span> (TRX) </span>
                    <input class="input-lg form-control" id="depositTxt" />
                    <br />
                    <button class="btn btn-lg btn-primary btn-block" onclick="deposite()">Deposite</button>
                </div>
                <div class="col-md-6">
                    <h2>your bank balance:</h2>
                    <h4 id="userbankBalance">0</h4><span> (TRX) </span>
                    <input class="input-lg form-control" id="withdrawTxt" />
                    <br />
                    <button class="btn btn-lg btn-primary btn-block" onclick="withdraw()">Withdraw</button>

                </div>
            </div>
        </div>
</body>
<script>

    const contractAddress = "TREHhrEVXTmiThEL352jigwNMfMznnG19A";
    var walletAddress = "";


    $("document").ready(function () {
        window.tronWeb.fullNode.host = 'https://api.nileex.io';
        getUserBankBalance();
        getBankBalance();
        getUserBalance();
    });

    function generateBankQR() {
        var QR_CODE = new QRCode("bankQRcode", {
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff00",
            correctLevel: QRCode.CorrectLevel.H,
        });

        QR_CODE.makeCode(contractAddress);
    }


    async function deposite() {
        let instance = await window.tronWeb.contract().at(contractAddress);
        let res = await instance.donate(walletAddress).send({ callValue: (parseFloat($("#depositTxt").val()) * 10 ** 6) });
        console.log(res);
    }

    async function withdraw() {
        let instance = await window.tronWeb.contract().at(contractAddress);
        let res = await instance.withdraw((parseFloat($("#withdrawTxt").val()) * 10 ** 6)).send();
        console.log(res);
    }


    async function getBankBalance() {
        generateBankQR();


                let instance = await window.tronWeb.contract().at(contractAddress);
                let res = await instance.getContractBalance().call();
                $("#bankBalance").text(parseInt(res._hex) / 10 ** 6);
                console.log(res);


    }

    async function getUserBankBalance() {

                let instance = await window.tronWeb.contract().at(contractAddress);
                let res = await instance.getBalance(walletAddress).call();
                console.log(res);
                $("#userbankBalance").text(parseInt(res) / 10 ** 6);

    }
    function getUserBalance() {
        var obj = setInterval(async () => {
            if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                clearInterval(obj);
                walletAddress = window.tronWeb.defaultAddress.base58;
                var balance = await tronWeb.trx.getBalance(walletAddress);
                balance = balance / (10 ** 6);
                $("#userWalletAddress").text(walletAddress);
                $("#userWalletBalance").text(balance);
            }
        }, 10);
    }
</script>

</html>